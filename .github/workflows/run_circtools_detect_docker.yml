name: circtools detect (docker)

on:
  workflow_run:
    workflows: ["Multi-arch docker container", "Multi-arch docker nightly"]
    types: [completed]

concurrency:
  group: ci-tests-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  run-circtest-docker:
    name: circtools circtest (Docker)
    runs-on: ubuntu-24.04
    env:
      GHCR_REPO: ghcr.io/jakobilab/circtools
    steps:
      - name: Set image tag based on triggering workflow
        run: |
          if [[ "${{ github.event.workflow_run.workflow }}" == "Multi-arch docker nightly" ]]; then
            echo "GHCR_IMAGE=${GHCR_REPO}:nightly" >> $GITHUB_ENV
          else
            echo "GHCR_IMAGE=${GHCR_REPO}:latest" >> $GITHUB_ENV
          fi
          echo "Using image: $(cat $GITHUB_ENV | grep GHCR_IMAGE)"

      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}

      - name: Pull image
        run: docker pull "${GHCR_IMAGE}"

      - name: Fix zcat on macOS
        if: runner.os == 'macOS'
        run: |
          sudo ln -sf $(which gzcat) /usr/local/bin/zcat

      - name: Unpack test dataset
        run: |
          tar xvf ./tests/data/circtools_example.tar.bz2
          cd circtools_example
          if [ -f genome.fa.gz ]; then gunzip -f genome.fa.gz; fi
          if [ -f annotation.gtf.gz ]; then gunzip -f annotation.gtf.gz; fi
          ls -lh

      - name: Run circtools detect (Docker AMD64)
        run: |
          cd circtools_example
          docker run --rm --platform linux/amd64 \
            -v "$(pwd):/host_rel/" \
            -v /:/host_os/ \
            -w /host_rel \
            "${GHCR_IMAGE}" \
            detect \
              @samplesheet \
              -ss -T 2 -D \
              -an annotation.gtf \
              -A genome.fa \
              -B @bam_files.txt \
              -D -M -G \
              -Nr 5 6 \
              -O ./circtools_ci -k


      - name: Inspect output
        run: |
          set -euo pipefail
          cd circtools_example/circtools_ci
          ls -la
          wc -l *

      - name: Compare against master output (Linux)
        run: |
          set -euo pipefail
          cd circtools_example
          MASTER_DIR="./circtools_ci_master"
          diff circtools_ci/CircRNACount "${MASTER_DIR}/CircRNACount"
          (cd circtools_ci && sha1sum -c "../circtools_ci_master/sha1sums.txt")
