name: circtools detect (docker)

on:
  #workflow_run:
    #workflows: ["Multi-arch docker container"]
    #types: [completed]
  schedule:
    - cron: '0 10 * * *'


concurrency:
  group: ci-tests-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  GHCR_IMAGE: ghcr.io/jakobilab/circtools:master  # <- change to a specific tag if desired

jobs:
  run-detect-docker:
    name: circtools detect (Docker AMD64)
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: docker_teests

      - name: Login to GHCR (optional if image is public)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull AMD64 image
        run: |
          docker pull --platform linux/amd64 "${GHCR_IMAGE}"
          docker image inspect "${GHCR_IMAGE}" --format '{{json .RepoTags}}'

      - name: Unpack test dataset
        run: |
          tar xvf ./tests/data/circtools_example.tar.bz2
          ls -la circtools_example

      - name: Run circtools detect (Docker AMD64)
        run: |
          docker run --rm --platform linux/amd64 \
            -v "${{ github.workspace }}:/work" \
            -w /work/circtools_example \
            "${GHCR_IMAGE}" \
            circtools detect \
              @samplesheet \
              -ss -T 2 -D \
              -an annotation.gtf \
              -A genome.fa \
              -B @bam_files.txt \
              -D -M -G \
              -Nr 5 6 \
              -O ./circtools_ci -k

      - name: Inspect output
        run: |
          set -euo pipefail
          cd circtools_example/circtools_ci
          ls -la
          wc -l *

      - name: Compare against master output (Linux)
        run: |
          set -euo pipefail
          cd circtools_example
          MASTER_DIR="./circtools_ci_master"
          diff circtools_ci/CircRNACount "${MASTER_DIR}/CircRNACount"
          # Verify checksums
          (cd circtools_ci && sha1sum -c "../circtools_ci_master/sha1sums.txt")
