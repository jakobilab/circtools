name: circtools nanopore (pip)

on:
  push:
  pull_request:

concurrency:
  group: ci-tests-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  nanopore-pip:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install circtools (pip)
        run: |
          python3 -m pip install -U pip setuptools wheel
          python3 -m pip install ./

      - name: Install BEDTools
        run: |
          sudo apt-get update
          sudo apt-get install -y make g++ zlib1g-dev
          wget https://github.com/arq5x/bedtools2/releases/download/v2.31.1/bedtools-2.31.1.tar.gz
          tar -xzf bedtools-2.31.1.tar.gz
          cd bedtools2
          make -j4
          sudo cp bin/* /usr/local/bin/

      - name: Unpack test dataset
        run: |
          tar xvf ./tests/data/circtools_example.tar.bz2
          cd circtools_example
          if [ -f genome.fa.gz ]; then gunzip -f genome.fa.gz; fi
          if [ -f annotation.gtf.gz ]; then gunzip -f annotation.gtf.gz; fi
          ls -lh

      - name: Subsample nanopore data
        run: |
          cd circtools_example
          cp ../tests/data/human_nanopore.fastq.gz .
          zcat human_nanopore.fastq.gz | head -n 4000000 | gzip > human_nanopore_1M.fastq.gz
          ls -lh human_nanopore_1M.fastq.gz

      - name: Download reference data (nanopore)
        run: |
          cd circtools_example
          mkdir -p reference
          circtools nanopore \
            -d \
            -R reference \
            -C hg38

      - name: Run circtools nanopore (pip)
        run: |
          cd circtools_example
          mkdir -p results
          circtools nanopore \
            -r \
            -s human_nanopore_1M.fastq.gz \
            -R reference \
            -C hg38 \
            -O results/ \
            --threads 4

      - name: Upload circRNA candidates artifact
        uses: actions/upload-artifact@v4
        with:
          name: circRNA-candidates-pip
          path: circtools_example/results/human_nanopore_1M.circRNA_candidates.annotated.txt
