name: circtools nanopore (docker)

on:
  push:

concurrency:
  group: ci-tests-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  GHCR_IMAGE: ghcr.io/jakobilab/circtools:master

jobs:
  run-nanopore-docker:
    name: circtools nanopore (Docker)
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}

      - name: Pull image
        run: |
          docker pull "${GHCR_IMAGE}"
          docker image inspect "${GHCR_IMAGE}" --format '{{json .RepoTags}}'

      - name: Unpack test dataset
        run: |
          tar xvf ./tests/data/circtools_example.tar.bz2
          cd circtools_example
          # Ensure genome + annotation are uncompressed
          if [ -f genome.fa.gz ]; then gunzip -f genome.fa.gz; fi
          if [ -f annotation.gtf.gz ]; then gunzip -f annotation.gtf.gz; fi
          ls -lh

      - name: Download reference data
        run: |
          cd circtools_example
          mkdir -p reference
          docker run --rm \
            -v "$(pwd):/host_rel/" \
            -w /host_rel \
            "${GHCR_IMAGE}" \
            nanopore \
              -d \
              -R reference \
              -C hg38



      - name: Run circtools nanopore (Docker)
        run: |
          cd circtools_example
          mkdir -p nanopore_output
          docker run --rm \
            -v "$(pwd):/host_rel/" \
            -w /host_rel \
            "${GHCR_IMAGE}" \
            nanopore \
              -r \
              -s human_nanopore_1M.fastq.gz \
              -R reference \
              -C hg38 \
              -O nanopore_output/ \
              --threads 16


      - name: Checking generated output against master output
        run: |
          cd circtools_example
          cd circtools_ci
          ls -la
          wc -l *
            if [ "$RUNNER_OS" = "Linux" ]; then
              MASTER_DIR="../nanopore_master"
              diff human_nanopore_1M.circRNA_candidates.annotated.txt "$MASTER_DIR/human_nanopore_1M.circRNA_candidates.annotated.txt"
              sha1sum -c "$MASTER_DIR/sha1sums.txt"
            elif [ "$RUNNER_OS" = "macOS" ] && [ "${{ matrix.os }}" = "macos-13" ]; then
              MASTER_DIR="../nanopore_master"
              diff human_nanopore_1M.circRNA_candidates.annotated.txt "$MASTER_DIR/human_nanopore_1M.circRNA_candidates.annotated.txt"
              shasum -a 1 -c "$MASTER_DIR/sha1sums.txt"
            elif [ "$RUNNER_OS" = "macOS" ]; then
              MASTER_DIR="../nanopore_master"
              diff human_nanopore_1M.circRNA_candidates.annotated.txt "$MASTER_DIR/human_nanopore_1M.circRNA_candidates.annotated.txt"
              shasum -a 1 -c "$MASTER_DIR/sha1sums.txt"
            else
              echo "Unsupported OS: $RUNNER_OS" >&2
              exit 1
            fi

      - name: Upload circRNA candidates artifact
        uses: actions/upload-artifact@v4
        with:
          name: circRNA-candidates
          path: circtools_example/nanopore_output/human_nanopore_1M.circRNA_candidates.annotated.txt

