name: circtools padlock (docker)

on:
  workflow_run:
    workflows: ["Multi-arch docker container"]
    types: [completed]

concurrency:
  group: ci-tests-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  GHCR_IMAGE: ghcr.io/jakobilab/circtools:master

jobs:
  run-padlock-docker:
    name: circtools padlock (Docker)
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}

      - name: Pull image
        run: |
          docker pull "${GHCR_IMAGE}"
          docker image inspect "${GHCR_IMAGE}" --format '{{json .RepoTags}}'
      
      - name: Fix zcat on macOS
        if: runner.os == 'macOS'
        run: |
          sudo ln -sf $(which gzcat) /usr/local/bin/zcat

      - name: Unpack test dataset
        run: |
          tar xvf ./tests/data/circtools_example.tar.bz2
          cd circtools_example
          if [ -f genome.fa.gz ]; then gunzip -f genome.fa.gz; fi
          if [ -f annotation.gtf.gz ]; then gunzip -f annotation.gtf.gz; fi
          ls -lh

      - name: Run circtools padlock (Docker)
        run: |
          cd circtools_example
          mkdir -p padlock_output
          docker run --rm \
            -v "$(pwd):/host_rel/" \
            -v /:/host_os/ \
            -w /host_rel \
            "${GHCR_IMAGE}" \
            padlock \
              -f ./genome.fa \
              -g ./annotation.gtf \
              -O mm \
              -G Slc16a9 \
              -T Slc16a9_padlock_design \
              -r 1 \
              -b \
              -o ./padlock_output

      - name: Check generated output against master
        run: |
          cd circtools_example/padlock_output
          ls -la
          wc -l *

          MASTER_DIR="../padlock_output_master"

          diff Slc16a9_padlock_design_linear_FSJ.csv "$MASTER_DIR/Slc16a9_padlock_design_linear_FSJ.csv"
          sha1sum -c "$MASTER_DIR/sha1sums.txt"
